<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takibi</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase SDK'larÄ± -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --brand-900:#992f00;
      --brand-700:#c84d00;
      --brand-600:#e56200;
      --brand-500:#ff7a1a;
      --brand-300:#ffb26e;
      --brand-100:#fff3e6;
      --ink:#23272b;
    }

    /* Modern gradient header */
    .app-navbar{
      background: linear-gradient(135deg, var(--brand-700), var(--brand-500));
      border-bottom: 1px solid rgba(255,255,255,.15);
    }
    .app-navbar .navbar-brand{
      font-weight: 800;
      letter-spacing:.2px;
    }
    .app-badge{
      background: rgba(255,255,255,.15);
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
    }

    body{
      background: linear-gradient(180deg, var(--brand-100), #ffffff 25%);
      color: var(--ink);
    }

    .app-card{
      border:1px solid var(--brand-300);
      box-shadow: 0 8px 24px rgba(238, 118, 0,.12);
    }

    .student-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      max-height: 440px;
      overflow:auto;
    }
    .student-card{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px;
      background:#fffdf9;
      border:1px solid var(--brand-300);
      border-left:6px solid var(--brand-500);
      border-radius:14px;
      transition:transform .2s ease, box-shadow .2s ease;
      cursor:pointer;
    }
    .student-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
    }
    .student-name{
      font-weight:700;
    }

    /* Buttons â€“ Bootstrap uyumlu turuncu tema */
    .btn-brand{
      --bs-btn-bg: var(--brand-500);
      --bs-btn-border-color: var(--brand-500);
      --bs-btn-hover-bg: var(--brand-600);
      --bs-btn-hover-border-color: var(--brand-600);
      --bs-btn-active-bg: var(--brand-700);
      --bs-btn-active-border-color: var(--brand-700);
      --bs-btn-color: #fff;
    }
    .btn-outline-brand{
      --bs-btn-color: var(--brand-600);
      --bs-btn-border-color: var(--brand-300);
      --bs-btn-hover-bg: var(--brand-500);
      --bs-btn-hover-border-color: var(--brand-500);
      --bs-btn-hover-color:#fff;
    }

    /* WhatsApp mini buton */
    .whatsapp-btn{
      border:0;
      border-radius: .6rem;
      padding: .45rem .6rem;
      font-size: .95rem;
      background:#25D366;
      color:#fff;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .whatsapp-btn:hover{ background:#1ebe5b; transform: translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.12) }

    /* YazdÄ±r: modern Ã§Ä±ktÄ± */
    @media print{
      body *{ visibility:hidden; }
      .print-area, .print-area *{ visibility:visible; }
      .print-area{ position:absolute; inset:0; padding:12mm; }
      @page{ size: A4 portrait; margin:10mm; }
    }

    /* Tablo gÃ¶rÃ¼nÃ¼mÃ¼ */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid #e1e1e1;
      border-radius:12px;
      overflow:hidden;
      font-size: 13px;
    }
    th{
      background: linear-gradient(180deg, #ffe4cc, #ffd7b3);
      color:#5a2c00;
      font-weight:700;
    }
    th,td{ padding:.55rem .65rem; border-bottom:1px solid #ececec; }
    tr:nth-child(even) td{ background:#fff8f1; }

    /* Form elementleri */
    .form-select, .form-control{
      border-radius: .8rem;
      border-color:#e9a86a;
    }

    /* SweetAlert geniÅŸ popup */
    .wide-popup{ width:500px !important; max-width: 92vw !important; }
    .centered-select{ display:block!important; margin:0 auto!important; width:90%!important; max-width:400px; font-size:16px; padding:10px; box-sizing:border-box; }

  </style>
</head>
<body>

  <!-- HEADER -->
 <nav class="navbar navbar-expand-lg app-navbar sticky-top py-3">
  <div class="container">
    <a class="navbar-brand text-white d-flex align-items-center gap-2" href="#">
      <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" alt="Fenomen Logo" class="logo" 
           style="height:40px; border-radius:6px;">
      <span class="fs-4">Fenomen Ã‡ocuk KulÃ¼bÃ¼</span>
    </a>
    <span class="badge rounded-pill app-badge ms-auto">Ã–dev Takibi</span>
  </div>
</nav>


  <!-- MAIN -->
  <main class="container my-4">
    <div class="card app-card p-3 p-md-4">
      <h1 class="h3 text-center mb-3" style="color:var(--brand-600)">Ã–dev Takibi</h1>

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label for="date" class="form-label fw-semibold">Tarih</label>
          <input type="date" id="date" class="form-control"/>
        </div>

        <div class="col-12 col-md-4">
          <label for="teacherSelect" class="form-label fw-semibold">Ã–ÄŸretmen</label>
          <select id="teacherSelect" class="form-select">
            <option value="">-- Ã–ÄŸretmen SeÃ§in --</option>
          </select>
        </div>

        <div class="col-12"><hr class="my-2" style="border-color:#ffd7b3"></div>

        <div class="col-12 col-md-3">
          <label for="gradeLevel" class="form-label fw-semibold" style="color:var(--brand-600)">SÄ±nÄ±f DÃ¼zeyi</label>
          <select id="gradeLevel" class="form-select">
            <option value="">-- SÄ±nÄ±f SeÃ§in --</option>
            <option value="8">8. SÄ±nÄ±f</option>
            <option value="7">7. SÄ±nÄ±f</option>
            <option value="6">6. SÄ±nÄ±f</option>
            <option value="5">5. SÄ±nÄ±f</option>
          </select>
        </div>

        <div class="col-12 col-md-5">
          <label for="unitSelect" class="form-label fw-semibold" style="color:var(--brand-600)">Ãœnite SeÃ§imi</label>
          <select id="unitSelect" class="form-select">
            <option value="">-- Ãœnite SeÃ§in --</option>
          </select>
        </div>

        <div class="col-12">
          <label for="homework" class="form-label fw-semibold">Ã–dev</label>
          <textarea id="homework" rows="2" class="form-control"></textarea>
        </div>

        <div class="col-12 col-md-4">
          <label for="classSelect" class="form-label fw-semibold">SÄ±nÄ±f</label>
          <select id="classSelect" class="form-select">
            <option value="">-- SÄ±nÄ±f SeÃ§in --</option>
          </select>
        </div>
      </div>

      <!-- Ã–ÄŸrenciler -->
      <div class="mt-3">
        <div id="students" class="student-grid"></div>
      </div>

      <!-- Aksiyonlar -->
      <div class="row row-cols-2 row-cols-md-3 g-2 g-md-3 mt-3">
        <div class="col">
          <button class="btn btn-brand w-100" onclick="printReport()">ğŸ–¨ï¸ YazdÄ±r</button>
        </div>
        <div class="col">
          <button class="btn btn-outline-brand w-100" onclick="saveFormToLocalStorage()">ğŸ’¾ Kaydet</button>
        </div>
        <div class="col">
          <button class="btn btn-outline-brand w-100" onclick="loadFormFromLocalStorage()">ğŸ“‚ YÃ¼kle</button>
        </div>
        <div class="col">
          <button class="btn btn-outline-danger w-100" onclick="clearLocalStorageForm()">ğŸ—‘ï¸ Sil</button>
        </div>
        <div class="col">
          <button class="btn btn-outline-brand w-100" onclick="updateFormInLocalStorage()">ğŸ” GÃ¼ncelle</button>
        </div>
        <div class="col">
          <button class="btn btn-outline-secondary w-100" onclick="refreshForm()">ğŸ”„ Yenile</button>
        </div>
      </div>
    </div>
  </main>

  <!-- PRINT AREA (JS dolduruyor) -->
  <div id="print-area" class="print-area" style="display:none;"></div>

  <!-- Firebase Config + App JS (orijinal mantÄ±k korunuyor) -->
  <script>
    // Firebase yapÄ±landÄ±rma (deÄŸiÅŸtirmedim)
    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <script>
    // ==== Orijinal JS + ufak iyileÅŸtirmeler ====

    const teachers = {};
    const studentData = {};
    const sÄ±nÄ±fSet = new Set();
    let currentFormKey = null; // YÃ¼klenen kayÄ±t anahtarÄ±
    let currentDateKey = "";   // Åu anki formdan oluÅŸturulan anahtar

    // Ã–ÄŸretmenler
    fetch("https://opensheet.elk.sh/1QYTBSXMfk4VLUYtSKchxmVWEZJ75pBy-2pIogWESoaw/Ogretmenler")
      .then(res => res.json())
      .then(data => {
        const teacherSelect = document.getElementById("teacherSelect");
        teacherSelect.innerHTML = '<option value="">-- Ã–ÄŸretmen SeÃ§in --</option>';
        data.forEach(row => {
          const branch = row["BRANS"];
          const name = row["OGRETMEN_ADI"];
          const subject = row["DERS_ADI"];
          teachers[branch] = { name, subject };
          const opt = document.createElement("option");
          opt.value = branch;
          opt.textContent = `${name} (${subject})`;
          teacherSelect.appendChild(opt);
        });
        teacherSelect.dispatchEvent(new Event("change"));
      })
      .catch(err => {
        console.error("Ã–ÄŸretmen verisi alÄ±namadÄ±:", err);
        Swal.fire("Hata", "Ã–ÄŸretmen listesi yÃ¼klenemedi.", "error");
      });

    // Ã–ÄŸrenciler
    fetch("https://opensheet.elk.sh/1QYTBSXMfk4VLUYtSKchxmVWEZJ75pBy-2pIogWESoaw/Ogrenciler")
      .then(res => res.json())
      .then(data => {
        data.forEach(row => {
          const sinif = row["SINIF"];
          const ad = row["ADSOYAD"];
          if (!studentData[sinif]) { studentData[sinif] = []; }
          studentData[sinif].push(ad);
          sÄ±nÄ±fSet.add(sinif);
        });

        const classSelect = document.getElementById("classSelect");
        classSelect.innerHTML = '<option value="">-- SÄ±nÄ±f SeÃ§in --</option>';
        Array.from(sÄ±nÄ±fSet)
          .sort((a, b) => a.localeCompare(b, 'tr', { numeric: true }))
          .forEach(sinif => {
            const opt = document.createElement("option");
            opt.value = sinif;
            opt.textContent = sinif;
            classSelect.appendChild(opt);
          });

        if (classSelect.value) classSelect.dispatchEvent(new Event("change"));
      })
      .catch(err => {
        console.error("Google Sheet'ten veri alÄ±namadÄ±:", err);
        Swal.fire("Hata", "Ã–ÄŸrenci listesi yÃ¼klenemedi.", "error");
      });

    // SÄ±nÄ±f deÄŸiÅŸince kartlarÄ± oluÅŸtur
    document.getElementById("classSelect").addEventListener("change", function() {
      const selectedClass = this.value;
      const container = document.getElementById("students");
      container.innerHTML = "";
      if (!studentData[selectedClass]) return;

      studentData[selectedClass]
        .slice()
        .sort((a, b) => a.localeCompare(b, 'tr', { sensitivity: 'base' }))
        .forEach(name => {
          const div = document.createElement("div");
          div.className = "student-card";
          div.innerHTML = `
            <span class="student-name" onclick="openStudentModal('${name}')">â–ª ${name}</span>
            <div class="d-flex gap-2 align-items-stretch">
              <select class="form-select student-status">
                <option value="yaptÄ±">âœ… YaptÄ±</option>
                <option value="yapmadÄ±">âŒ YapmadÄ±</option>
                <option value="eksik">â— Eksik</option>
                <option value="gelmedi">â›” Gelmedi</option>
              </select>
              <button class="whatsapp-btn" title="WhatsApp ile gÃ¶nder" onclick="
                const card = this.closest('.student-card');
                const studentName = card.querySelector('.student-name').innerText.replace('â–ª ', '');
                const statusSelect = card.querySelector('.student-status');
                const statusText = statusSelect.options[statusSelect.selectedIndex].text;
                const icon = statusText.split(' ')[0];
                const label = statusText.split(' ').slice(1).join(' ');
                generateWhatsappLink(studentName, icon, label);
              ">ğŸ“©</button>
            </div>`;
          container.appendChild(div);
        });
    });

    // YazdÄ±r (modern Ã§Ä±ktÄ±)
    function printReport() {
      const rawDate = document.getElementById("date").value;
      const grade = document.getElementById("gradeLevel").value;
      const unit = document.getElementById("unitSelect").value;
      const homework = document.getElementById("homework").value;
      const selectedClass = document.getElementById("classSelect").value;
      const teacherKey = document.getElementById("teacherSelect").value;
      const teacherInfo = teachers[teacherKey];
      const teacher = teacherInfo?.name || teacherKey;
      const students = document.querySelectorAll(".student-card");

      if (!rawDate || !grade || !unit || !homework || !selectedClass) {
        Swal.fire({ icon:'warning', title:'Eksik Alan!', text:'Tarih, sÄ±nÄ±f, Ã¼nite ve Ã¶dev bilgilerini doldurunuz.' }); return;
      }
      if (!teacher) { Swal.fire({ icon:'warning', title:'Ã–ÄŸretmen SeÃ§ilmedi', text:'LÃ¼tfen Ã¶ÄŸretmen seÃ§iniz.'}); return; }
      if (students.length === 0){ Swal.fire({ icon:'error', title:'Ã–ÄŸrenci BulunamadÄ±', text:'SeÃ§ilen sÄ±nÄ±fa ait Ã¶ÄŸrenci bulunamadÄ±.'}); return; }

      const [y, m, d] = rawDate.split("-");
      const dateFormatted = `${d}.${m}.${y}`;

      let yapanlar = "", digerleri = "";
      students.forEach(card => {
        const name = card.querySelector(".student-name").innerText.replace("â–ª ", "");
        const status = card.querySelector(".student-status").value;
        const label = card.querySelector(".student-status").selectedOptions[0].text;
        const row = `<tr><td>${name}</td><td>${label}</td></tr>`;
        if (status === "yaptÄ±") yapanlar += row; else digerleri += row;
      });

      const brandTop = `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" alt="Logo" style="height:40px; border-radius:6px;">
      <div style="font-size:18px;font-weight:800;color:#c84d00">Fenomen Ã‡ocuk KulÃ¼bÃ¼</div>
    </div>
    <span style="font-size:12px;padding:6px 10px;border-radius:999px;background:#fff0e4;border:1px solid #ffc999;color:#a04100">Ã–dev Takip Raporu</span>
  </div>`;


      const infoRow = `
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin:8px 0 14px">
          <div style="padding:8px 10px;border:1px solid #ffe0c2;border-radius:10px;background:#fff8f1"><b>Ã–ÄŸretmen:</b> ${teacher}</div>
          <div style="padding:8px 10px;border:1px solid #ffe0c2;border-radius:10px;background:#fff8f1"><b>Tarih:</b> ${dateFormatted}</div>
          <div style="padding:8px 10px;border:1px solid #ffe0c2;border-radius:10px;background:#fff8f1"><b>SÄ±nÄ±f:</b> ${selectedClass}</div>
          <div style="padding:8px 10px;border:1px solid #ffe0c2;border-radius:10px;background:#fff8f1"><b>Ãœnite:</b> ${unit}</div>
        </div>`;

      const hw = `<div style="margin:6px 0 12px;padding:10px;border-left:5px solid #ff9a44;background:#fff5eb;border:1px solid #ffd4a8;border-radius:10px"><b>Ã–dev:</b> ${homework}</div>`;

      const section = (title, rows)=>`
        <h2 style="font-size:16px;color:#c84d00;margin:14px 0 6px">${title}</h2>
        <table>
          <tr><th style="width:70%">Ã–ÄŸrenci AdÄ±</th><th>Durumu</th></tr>
          ${rows || `<tr><td colspan="2">KayÄ±t yok</td></tr>`}
        </table>`;

      const page = (title, rows)=>`
        <div>
          ${brandTop}
          ${infoRow}
          ${hw}
          ${section(title, rows)}
        </div>`;

      const printHTML = `
        <html><head>
          <title>Ã–dev Raporu - ${dateFormatted} - ${selectedClass} - ${unit}</title>
          <style>
            body{ font-family:Arial, sans-serif; margin:0; padding:12mm; color:#222 }
            h1,h2,h3{ margin:0 }
            table{ width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e1e1e1; border-radius:12px; overflow:hidden; font-size:13px }
            th{ background:linear-gradient(180deg,#ffe4cc,#ffd7b3); color:#5a2c00; font-weight:700 }
            th,td{ padding:.55rem .65rem; border-bottom:1px solid #ececec }
            tr:nth-child(even) td{ background:#fff8f1 }
            .page-break{ page-break-before:always }
            @page{ size:A4 portrait; margin:10mm }
          </style>
        </head>
        <body>
          ${page("âœ… Ã–devi Yapanlar", yapanlar)}
          <div class="page-break"></div>
          ${page("âŒ Yapmayan / â— Eksik / â›” Gelmeyen", digerleri)}
        </body></html>`;

      const w = window.open('', '_blank');
      w.document.open(); w.document.write(printHTML); w.document.close(); w.focus();
      w.onload = () => w.print();
    }

    // Ãœnite listesi
    const allUnits = {
      turkce:{ "5":["SÃ¶zcÃ¼kte Anlam","CÃ¼mlede Anlam","Paragrafta Anlam","Dil Bilgisi","YazÄ±m KurallarÄ±","Noktalama Ä°ÅŸaretleri","Metin TÃ¼rleri","AnlatÄ±m BozukluklarÄ±"],
               "6":["SÃ¶zcÃ¼kte Anlam","CÃ¼mlede Anlam","Paragraf Yorumu","Fiil, Zarf, SÄ±fat","YazÄ±m ve Noktalama","Paragraf Ã‡Ã¶zÃ¼mleme","Metin YapÄ±sÄ±","Deyim ve AtasÃ¶zleri"],
               "7":["SÃ¶zcÃ¼kte Anlam","Paragraf Bilgisi","CÃ¼mlede Anlam","Dil Bilgisi","YazÄ±lÄ± AnlatÄ±m","Metin TÃ¼rleri","AnlatÄ±m BozukluklarÄ±"],
               "8":["SÃ¶zcÃ¼kte ve CÃ¼mlede Anlam","Paragraf Bilgisi","Dil Bilgisi","Metin TÃ¼rleri","YazÄ±m ve Noktalama","AnlatÄ±m BozukluklarÄ±"] },
      matematik:{ "5":["DoÄŸal SayÄ±lar","Kesirler","OndalÄ±k SayÄ±lar","Geometri","Veri ve Ä°statistik","Zaman","Ã–rÃ¼ntÃ¼ler ve SÃ¼reÃ§ler"],
                  "6":["Tam SayÄ±lar","Kesirler ve OndalÄ±klar","Oran ve OrantÄ±","Cebirsel Ä°fadeler","Geometrik Cisimler","Veri ve OlasÄ±lÄ±k"],
                  "7":["Tam SayÄ±lar","Rasyonel SayÄ±lar","Denklemler","Oran ve OrantÄ±","Geometrik Cisimler","AÃ§Ä±lar ve Ã‡okgenler","Veri Yorumlama"],
                  "8":["Ã‡arpanlar ve Katlar","ÃœslÃ¼ SayÄ±lar","KarekÃ¶klÃ¼ Ä°fadeler","Denklemler","EÅŸitsizlikler","Geometrik Cisimler","OlasÄ±lÄ±k","EÅŸlik ve Benzerlik"] },
      fen:{ "5":["GÃ¼neÅŸ, DÃ¼nya ve Ay","Kuvvet ve Hareket","Maddeyi TanÄ±yalÄ±m","IÅŸÄ±k ve Ses","CanlÄ±lar DÃ¼nyasÄ±","Elektrik ve Enerji"],
            "6":["Destek ve Hareket Sistemi","Sindirim â€“ DolaÅŸÄ±m â€“ Solunum","Kuvvet â€“ SÃ¼rat","YoÄŸunluk â€“ IsÄ± â€“ Hal DeÄŸiÅŸimi","Ses","Elektrik ve YaÅŸam"],
            "7":["GÃ¼neÅŸ Sistemi","HÃ¼cre ve BÃ¶lÃ¼nmeler","Kuvvet â€“ Enerji","Madde ve KarÄ±ÅŸÄ±mlar","IÅŸÄ±k â€“ Ses","CanlÄ±larda Enerji","Elektrik Devreleri"],
            "8":["Mevsimler ve Ä°klim","DNA ve Genetik Kod","BasÄ±nÃ§","Madde ve EndÃ¼stri","Basit Makineler","Enerji DÃ¶nÃ¼ÅŸÃ¼mleri","Elektrik YÃ¼kleri"] },
      sosyal:{ "5":["Birlikte YaÅŸama","KÃ¼ltÃ¼rel Miras","Ä°nsanlar, Yerler ve Ã‡evreler","Ãœretim, DaÄŸÄ±tÄ±m, TÃ¼ketim","Birey ve Toplum","Bilim, Teknoloji, Toplum"],
               "6":["Zaman ve Mekan","KÃ¼ltÃ¼r ve Miras","Ä°nsanlar ve Yerler","Bilim â€“ Teknoloji â€“ Toplum","Ekonomi â€“ Kaynaklar","Demokrasi ve YurttaÅŸlÄ±k"],
               "7":["KÃ¼ltÃ¼r ve Miras","Ä°nsanlar ve Yerler","Bilimsel GeliÅŸmeler","Ekonomi ve Kaynaklar","VatandaÅŸlÄ±k ve Haklar","KÃ¼resel BaÄŸlantÄ±lar"],
               "8":["Ä°nkÄ±lap Tarihi","KurtuluÅŸ SavaÅŸÄ±","Cumhuriyet DÃ¶nemi","Demokrasi KÃ¼ltÃ¼rÃ¼","Toplum ve DeÄŸerler"] },
      ingilizce:{ "5":["Hello!","My Town","Games and Hobbies","Health","The Animal Shelter","My Daily Routine","My House","My Clothes"],
                  "6":["Life","Weather","Occupations","Downtown","Holidays","Environment","Bookworms","Democracy"],
                  "7":["Appearance","Sports","Biographies","Movies and Media","Environment","Celebrations","Dreams","Jobs and Future"],
                  "8":["Friendship","Teen Life","In the Kitchen","On the Phone","The Internet","Adventures","Tourism","Science"] },
      din:{ "5":["Ä°slam'Ä±n Temel Ä°nanÃ§larÄ±","Peygamberimiz ve Ailesi","Ä°badetler","Ahlak ve DeÄŸerler","Kuranâ€™dan Mesajlar"],
            "6":["Allah Ä°nancÄ±","Peygamberler ve Dualar","Ä°badet Bilinci","Ä°slam AhlakÄ±","Toplumsal Sorumluluk"],
            "7":["Ä°nanÃ§ ve Ä°badet","Peygamberimizin HayatÄ±","Kur'an ve MesajlarÄ±","Ahlak ve DavranÄ±ÅŸ","Din KÃ¼ltÃ¼rÃ¼"],
            "8":["Ä°slamâ€™da Kader","Ä°slamâ€™da Sosyal Adalet","ZekÃ¢t ve Sadaka","Hz. Muhammedâ€™in Ã–rnekliÄŸi","Kur'anâ€™Ä±n Ã–zellikleri"] }
    };

    window.onload = function() {
      document.getElementById("date").addEventListener("change", generateDateKey);
      document.getElementById("classSelect").addEventListener("change", generateDateKey);
      document.getElementById("homework").addEventListener("input", generateDateKey);
    };

    function generateWhatsappLink(name, statusIcon, statusLabel) {
      const rawDate = document.getElementById("date").value;
      const unit = document.getElementById("unitSelect").value;
      const homework = document.getElementById("homework").value;

      const teacherKey = document.getElementById("teacherSelect").value;
      const teacherInfo = teachers[teacherKey];
      const subject = teacherInfo?.subject || unit;
      const teacherName = teacherInfo?.name || "Ã–ÄŸretmen";

      if (!rawDate) {
        Swal.fire({ icon:'warning', title:'Tarih Eksik!', text:'LÃ¼tfen tarih giriniz.'}); return;
      }

      const [y,m,d] = rawDate.split("-");
      const formattedDate = `${d}.${m}.${y}`;

      const message =
`ğŸ“¢ *Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Bilgilendirme*

SayÄ±n Velim,

ğŸ“ Ã–ÄŸrenci: *${name}*
ğŸ‘©â€ğŸ« Ã–ÄŸretmen: *${teacherName} (${subject})*
ğŸ“… Tarih: *${formattedDate}*
ğŸ“š Konu: *${unit}*
ğŸ“ Ã–dev: *${homework}*
ğŸ“ Durum: ${statusIcon} *${statusLabel}*

SaygÄ±larÄ±mÄ±zla,
*Fenomen Ã‡ocuk KulÃ¼bÃ¼*`;

      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    }

    function updateUnitOptions() {
      const grade = document.getElementById("gradeLevel").value;
      const branch = document.getElementById("teacherSelect").value;
      const unitSelect = document.getElementById("unitSelect");
      unitSelect.innerHTML = '<option value="">-- Ãœnite SeÃ§in --</option>';
      if (grade && branch && allUnits[branch] && allUnits[branch][grade]) {
        allUnits[branch][grade].forEach(unit => {
          const opt = document.createElement("option");
          opt.value = unit; opt.textContent = unit; unitSelect.appendChild(opt);
        });
      }
    }
    document.getElementById("gradeLevel").addEventListener("change", updateUnitOptions);
    document.getElementById("teacherSelect").addEventListener("change", updateUnitOptions);

    function saveFormToLocalStorage() {
      if (Object.keys(teachers).length === 0) {
        Swal.fire("UyarÄ±","Ã–ÄŸretmen verisi henÃ¼z yÃ¼klenmedi. LÃ¼tfen birkaÃ§ saniye sonra tekrar deneyin.","warning");
        return;
      }
      generateDateKey();
      if (!currentDateKey) { Swal.fire("Hata","KayÄ±t anahtarÄ± oluÅŸturulamadÄ±. LÃ¼tfen tÃ¼m alanlarÄ±n dolu olduÄŸundan emin olun.","error"); return; }

      const formData = {
        date: document.getElementById("date").value,
        class: document.getElementById("classSelect").value,
        grade: document.getElementById("gradeLevel").value,
        unit: document.getElementById("unitSelect").value,
        teacher: document.getElementById("teacherSelect").value,
        homework: document.getElementById("homework").value.trim(),
        students: Array.from(document.querySelectorAll(".student-card")).map(card => ({
          name: card.querySelector(".student-name").innerText.replace("â–ª ", ""),
          status: card.querySelector(".student-status").value
        }))
      };

      database.ref('forms/' + currentDateKey).set(formData)
        .then(() => Swal.fire("Kaydedildi", `"${currentDateKey}" Firebase'e baÅŸarÄ±yla kaydedildi.`, "success"))
        .catch((error) => { console.error("Firebase'e kayÄ±t hatasÄ±:", error); Swal.fire("Hata","Veri Firebase'e kaydedilemedi.","error"); });
    }

    function loadFormFromLocalStorage() {
      database.ref('forms').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (!data) { Swal.fire({ icon:'info', title:"KayÄ±t BulunamadÄ±", text:"Firebase'de kayÄ±tlÄ± hiÃ§bir form yok.", confirmButtonText:"Tamam", customClass:{ popup:'wide-popup', input:'centered-select' } }); return; }

// Filtreledikten sonra sÄ±ralÄ±yoruz
const keys = Object.keys(data)
  .filter(key => key.startsWith("Fen Bilimleri"))
  .sort((a, b) => {
    const dateA = new Date(data[a].date);
    const dateB = new Date(data[b].date);
    return dateB - dateA; // bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe => en yeni baÅŸta
  });

          if (keys.length === 0) { Swal.fire({ icon:'info', title:"KayÄ±t BulunamadÄ±", text:"Fen Bilimleri'ne ait kayÄ±t bulunamadÄ±.", confirmButtonText:"Tamam" }); return; }

          Swal.fire({
            title: "YÃ¼klenecek kayÄ±t seÃ§in",
            input: "select",
            inputOptions: keys.reduce((o,k)=> (o[k]=k,o),{}),
            inputPlaceholder: "KayÄ±t seÃ§in",
            showCancelButton: true, confirmButtonText: "YÃ¼kle", cancelButtonText: "Ä°ptal",
            customClass:{ popup:'wide-popup', input:'centered-select' }, inputAttributes:{ style:'font-size:15px;' }
          }).then(result => {
            if (result.isConfirmed) {
              const selectedKey = result.value;
              currentFormKey = selectedKey;
              const formData = data[selectedKey];

              document.getElementById("date").value = formData.date;
              document.getElementById("classSelect").value = formData.class;
              document.getElementById("gradeLevel").value = formData.grade;
              document.getElementById("teacherSelect").value = formData.teacher;
              document.getElementById("homework").value = formData.homework;

              updateUnitOptions();
              setTimeout(()=>{ document.getElementById("unitSelect").value = formData.unit; }, 50);
              document.getElementById("classSelect").dispatchEvent(new Event("change"));

              setTimeout(() => {
                const cards = document.querySelectorAll(".student-card");
                const notFound = [];
                formData.students.forEach(saved => {
                  const match = Array.from(cards).find(card => card.querySelector(".student-name").innerText.replace("â–ª ","") === saved.name);
                  if (match) match.querySelector(".student-status").value = saved.status;
                  else notFound.push(saved.name);
                });
                if (notFound.length) {
                  Swal.fire({ icon:"info", title:"Listede olmayan Ã¶ÄŸrenciler", html:`<b>${notFound.length}</b> Ã¶ÄŸrenci listede bulunamadÄ±:<br><br><code>${notFound.join("<br>")}</code>`, customClass:{ popup:'wide-popup' } });
                }
              }, 150);
            }
          });
        })
        .catch(error => { console.error("Firebase'den veri alÄ±namadÄ±:", error); Swal.fire("Hata","Veriler yÃ¼klenirken bir sorun oluÅŸtu.","error"); });
    }

    function clearLocalStorageForm() {
      database.ref('forms').once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (!data) { Swal.fire({ icon:'info', title:"KayÄ±t Yok", text:"Silinecek kayÄ±t bulunamadÄ±.", confirmButtonText:"Tamam", customClass:{ popup:'wide-popup' } }); return; }

const keys = Object.keys(data)
  .filter(key => key.startsWith("Fen Bilimleri"))
  .sort((a, b) => {
    const dateA = new Date(data[a].date);
    const dateB = new Date(data[b].date);
    return dateB - dateA; // bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe => en yeni baÅŸta
  });
          if (keys.length === 0) { Swal.fire({ icon:'info', title:"KayÄ±t Yok", text:"Fen Bilimleri'ne ait silinebilir kayÄ±t bulunamadÄ±.", confirmButtonText:"Tamam", customClass:{ popup:'wide-popup' } }); return; }

          Swal.fire({
            title: "Silinecek kaydÄ± seÃ§in",
            input: "select",
            inputOptions: keys.reduce((o,k)=> (o[k]=k,o),{}),
            inputPlaceholder: "Silinecek kayÄ±t seÃ§in",
            showCancelButton: true,
            confirmButtonText: "Sil", cancelButtonText: "Ä°ptal",
            showDenyButton: true, denyButtonText: "ğŸ§¨ Toplu Sil",
            customClass:{ popup:'wide-popup', input:'centered-select' }
          }).then(result => {
            if (result.isConfirmed) {
              const selectedKey = result.value;
              database.ref('forms/' + selectedKey).remove()
                .then(()=> Swal.fire({ icon:'success', title:"Silindi", text:`"${selectedKey}" kaydÄ± Firebase'den silindi.`, customClass:{ popup:'wide-popup' } }))
                .catch(err => { console.error("Firebase silme hatasÄ±:", err); Swal.fire("Hata","KayÄ±t silinirken hata oluÅŸtu.","error"); });
            } else if (result.isDenied) {
              Swal.fire({
                icon:'warning', title:'Emin misiniz?', text:'TÃ¼m kayÄ±tlar kalÄ±cÄ± olarak silinecek!',
                showCancelButton:true, confirmButtonText:'Evet, Sil', cancelButtonText:'VazgeÃ§'
              }).then(confirm => {
                if (confirm.isConfirmed) {
                  const keysToDelete = Object.keys(data).filter(key => !key.startsWith("Quiz"));
                  const updates = {}; keysToDelete.forEach(k => updates[`forms/${k}`] = null);
                  database.ref().update(updates)
                    .then(()=> Swal.fire({ icon:'success', title:"Hepsi Silindi", text:`"${keysToDelete.length}" kayÄ±t silindi.`, customClass:{ popup:'wide-popup' } }))
                    .catch(err => { console.error("Toplu silme hatasÄ±:", err); Swal.fire("Hata","Toplu silme baÅŸarÄ±sÄ±z.","error"); });
                }
              });
            }
          });
        })
        .catch(error => { console.error("Firebase okuma hatasÄ±:", error); Swal.fire("Hata","Veriler alÄ±nÄ±rken bir hata oluÅŸtu.","error"); });
    }

    function updateFormInLocalStorage() {
      if (!currentFormKey) { Swal.fire("GÃ¼ncelleme BaÅŸarÄ±sÄ±z","LÃ¼tfen Ã¶nce bir kayÄ±t yÃ¼kleyin.","error"); return; }
      Swal.fire({
        title:"GÃ¼ncellemek istediÄŸinize emin misiniz?",
        text:`"${currentFormKey}" Ã¼zerine yazÄ±lacak.`,
        icon:"question", showCancelButton:true,
        confirmButtonText:"Evet, GÃ¼ncelle", cancelButtonText:"VazgeÃ§"
      }).then(result => {
        if (result.isConfirmed) {
          const formData = {
            date: document.getElementById("date").value,
            class: document.getElementById("classSelect").value,
            grade: document.getElementById("gradeLevel").value,
            unit: document.getElementById("unitSelect").value,
            teacher: document.getElementById("teacherSelect").value,
            homework: document.getElementById("homework").value.trim(),
            students: Array.from(document.querySelectorAll(".student-card")).map(card => ({
              name: card.querySelector(".student-name").innerText.replace("â–ª ", ""),
              status: card.querySelector(".student-status").value
            }))
          };
          database.ref('forms/' + currentFormKey).set(formData)
            .then(()=> Swal.fire("GÃ¼ncellendi", `"${currentFormKey}" Firebase Ã¼zerinde baÅŸarÄ±yla gÃ¼ncellendi.`, "success"))
            .catch((error)=>{ console.error("Firebase gÃ¼ncelleme hatasÄ±:", error); Swal.fire("Hata","GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu.","error"); });
        }
      });
    }

    function sanitizeKeyPart(str) {
      return String(str || "").replace(/[.#$/\[\]]/g, "-").replace(/\s+/g, " ").trim();
    }

    function generateDateKey() {
      const raw = document.getElementById("date").value;
      const date = raw.includes("T") ? raw.split("T")[0] : raw;
      const selectedClass = document.getElementById("classSelect").value;
      const homework = document.getElementById("homework").value.trim();
      const teacherKey = document.getElementById("teacherSelect").value;
      const subject = teachers[teacherKey]?.subject || "";
      if (!subject || !date || !selectedClass || !homework) { currentDateKey = ""; return; }
      const keySubject = sanitizeKeyPart(subject);
      const keyClass   = sanitizeKeyPart(selectedClass);
      const keyDate    = sanitizeKeyPart(date);
      const keyHw      = sanitizeKeyPart(homework);
      const randomId = Math.random().toString(36).substring(2, 6);
      currentDateKey = `${keySubject} - ${keyDate} - ${keyClass} - ${keyHw} - ${randomId}`;
    }

    function getStatusLabel(status) {
      switch (status) {
        case 'yaptÄ±': return 'âœ… YaptÄ±';
        case 'yapmadÄ±': return 'âŒ YapmadÄ±';
        case 'eksik': return 'â— Eksik';
        case 'gelmedi': return 'â›” Gelmedi';
        default: return 'â“ Bilinmiyor';
      }
    }

    function openStudentModal(studentName) {
      if (Object.keys(teachers).length === 0) {
        Swal.fire({ icon:'warning', title:'Veri HazÄ±rlanÄ±yor', text:'Ã–ÄŸretmen verileri henÃ¼z yÃ¼klenmedi. LÃ¼tfen bir Ã¶ÄŸretmen seÃ§iniz' });
        return;
      }
      const oneMonthAgo = new Date(); oneMonthAgo.setMonth(oneMonthAgo.getMonth()-1);
      database.ref('forms').once('value')
        .then(snapshot => {
          const allForms = snapshot.val();
          if (!allForms) { Swal.fire({ icon:'info', title:'Veri Yok', text:'HiÃ§bir kayÄ±t bulunamadÄ±.' }); return; }

          const reports = [];
          Object.entries(allForms).forEach(([key, data]) => {
            const formDate = new Date(data.date);
            if (isNaN(formDate.getTime()) || formDate < oneMonthAgo) return;
            const match = data.students?.find(s => s.name === studentName); if (!match) return;
            const selectedTeacher = document.getElementById("teacherSelect").value;
            if (selectedTeacher && data.teacher !== selectedTeacher) return;

            const formattedDate = new Date(data.date).toLocaleDateString('tr-TR');
            const teacherName = teachers[data.teacher]?.name || data.teacher || "-";
            const subject = teachers[data.teacher]?.subject || "-";
            reports.push({ date: formattedDate, unit: data.unit, homework: data.homework, status: match.status, statusLabel: getStatusLabel(match.status), teacher: teacherName, subject });
          });

          if (!reports.length) { Swal.fire({ icon:'info', title:'KayÄ±t BulunamadÄ±', text:`${studentName} iÃ§in son 1 ayda kayÄ±tlÄ± bir Ã¶dev verisi bulunamadÄ±.` }); return; }

          const sample = reports[0];
          const msgHeader = `ğŸ“¢ *Fenomen Ã‡ocuk KulÃ¼bÃ¼ - Ã–dev Takip Raporu*\n\nSayÄ±n Velimiz,\n\nğŸ“ Ã–ÄŸrenciniz: *${studentName}*\nğŸ‘©â€ğŸ« Ã–ÄŸretmen: *${sample.teacher}*\nğŸ“Œ Ders: *${sample.subject}*\nğŸ—“ï¸ DÃ¶nem: *Son 1 Ay*\n\nğŸ“š *Ã–dev KatÄ±lÄ±m Listesi:*\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
          const msgBody = reports.map(r => `ğŸ“… *${r.date}*\nğŸ“ Ã–dev: *${r.homework}*\nğŸ“˜ Ãœnite: *${r.unit}*\nğŸ“Œ Durum: ${r.statusLabel}\n`).join('\n');
          const msgFooter = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nğŸ“¨ Geri bildirim ve detaylÄ± bilgi iÃ§in Ã¶ÄŸretmeninizle iletiÅŸime geÃ§ebilirsiniz.\nSaygÄ±larÄ±mÄ±zla,\n*Fenomen Ã‡ocuk KulÃ¼bÃ¼*';
          const fullMessage = `${msgHeader}${msgBody}${msgFooter}`;

          Swal.fire({
            title: studentName,
            html: `<pre style="text-align:left;white-space:pre-wrap;font-size:13px;padding:10px 0">${fullMessage}</pre>`,
            showCancelButton: true, confirmButtonText: 'ğŸ“¤ GÃ¶nder', cancelButtonText: 'Kapat',
            customClass: { popup: 'wide-popup' }
          }).then(result => { if (result.isConfirmed) { const whatsappURL = `https://wa.me/?text=${encodeURIComponent(fullMessage)}`; window.open(whatsappURL, '_blank'); }});
        })
        .catch(error => { console.error("Veri Ã§ekme hatasÄ±:", error); Swal.fire("Hata", "Veriler alÄ±namadÄ±.", "error"); });
    }

    function refreshForm() {
      document.getElementById("date").value = "";
      document.getElementById("teacherSelect").value = "";
      document.getElementById("gradeLevel").value = "";
      document.getElementById("unitSelect").innerHTML = '<option value="">-- Ãœnite SeÃ§in --</option>';
      document.getElementById("homework").value = "";
      document.getElementById("classSelect").value = "";
      document.getElementById("students").innerHTML = "";
    }
  </script>

  <!-- Bootstrap JS (opsiyonel ama dropdown vb. iÃ§in iyi olur) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
